<script setup>
import { ref, computed, watch, onMounted, provide, toRaw } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import UserTag from '@/components/UserTag'
import AvatarBlockie from '@/components/AvatarBlockie'
import Addr from '@/components/Addr'
import AddressesTag from '@/components/AddressesTag'
import UserAvatar from '@/components/UserAvatar'
import SvgChevronDown from '@/components/SvgChevronDown'
import SvgPlusMinusRadicle from '@/components/SvgPlusMinusRadicle'
import UserProject from '@/components/UserProject'
import UserNft from '@/components/UserNFT'
import IconSplit from '@/components/IconSplit'
import ModalDripTo from '@/components/ModalDripTo'
import ModalCollectDrips from '@/components/ModalCollectDrips'
import ModalEditDripsSelect from '@/components/ModalEditDripsSelect'
import ModalDripsEdit from '@/components/ModalDripsEdit'
import ModalSplitsEdit from '@/components/ModalSplitsEdit'
import SvgDai from '@/components/SvgDai'
import ProjectDetail from '@/components/ProjectDetail'
import store from '@/store'
import { utils } from 'ethers'
import { toDAI, toDAIPerMo, formatSplitsEvents } from '@/utils'
import api from '@/api'

const route = useRoute()
const router = useRouter()
const ensName = computed(() => store.state.addresses[route.params.address]?.ens)
const dripModalOpen = ref(false)
const collectModalOpen = ref(false)
const showAllSenders = ref(false)
const showAllReceivers = ref(false)

// my account
const isMyUser = computed(() => store.state.address === route.params.address)
const editDripsSelect = ref(false)
const edit = ref(null) // 'drips' : 'splits'
const collectableAmts = ref()
const totalFunds = computed(() => {
  return !collectableAmts.value ? -1
    : toDAI(collectableAmts.value[0].add(collectableAmts.value[1]))
})

watch(isMyUser, (val) => val && getMyCollectable())

const getMyCollectable = () => {
  store.dispatch('getCollectable', { address: route.params.address })
    .then(amts => { collectableAmts.value = amts })
    .catch(console.error)
}

// drips in
const splitsIn = ref()
const dripsIn = ref()

const allDripsIn = computed(() => {
  if (!dripsIn.value && !splitsIn.value) {
    return undefined // "loading"
  }
  const dIn = dripsIn.value || []
  const sIn = splitsIn.value || []
  return [...dIn, ...sIn]
})

const allSenders = computed(() => {
  return allDripsIn.value?.map(d => d.sender)
})
  
// get splits In
const getSplitsIn = async () => {
  try {
    const splits = await store.dispatch('getSplitsByReceiver', route.params.address)
    // format + save
    splitsIn.value = splits.map(split => ({
      ...split,
      receiver: [split.receiver]
    }))
  } catch (e) {
    console.error(e)
    splitsIn.value = []
  }
}

// get drips In
const getDripsIn = async () => {
  try {
    const entries = await store.dispatch('getDripsByReceiver', route.params.address)
    console.log(entries)
    // format + save
    dripsIn.value = entries.map(drip => ({
      ...drip,
      receiver: [drip.receiver], // [drip[0]],
      amount: toDAIPerMo(drip.amtPerSec) // toDAIPerMo(drip[1])
    }))
  } catch (e) {
    console.error(e)
    dripsIn.value = []
  }
}

// drips out
const splitsOut = ref()
const dripsOut = ref()

const allDripsOut = computed(() => {
  if (!dripsOut.value && !splitsOut.value) {
    return undefined // "loading"
  }
  const dOut = dripsOut.value || []
  const sOut = splitsOut.value || []
  return [...dOut, ...sOut]
})

const allReceivers = computed(() => {
  return allDripsOut.value?.filter(d => d.receiver.length).map(d => d.receiver[0])
})
  
// get splits out
const getSplitsOut = async () => {
  try {
    const splits = await store.dispatch('getSplitsBySender', route.params.address)
    // format + save
    splitsOut.value = splits.map(split => ({
      ...split,
      receiver: [split.receiver]
    }))
  } catch (e) {
    console.error(e)
    splitsOut.value = []
  }
}

// get drips out
const withdrawable = ref()
let getWithdrawable
const getDripsOut = async () => {
  try {
    const config = await store.dispatch('getDripsBySender', route.params.address)
    // format + save
    dripsOut.value = config.receivers.map(drip => ({
      sender: route.params.address,
      receiver: [drip.receiver], // [drip[0]],
      amount: toDAIPerMo(drip.amtPerSec) // toDAIPerMo(drip[1])
    }))
    getWithdrawable = config.withdrawable
    withdrawable.value = getWithdrawable()
  } catch (e) {
    console.error(e)
    dripsOut.value = []
  }
}

// get nfts
const nfts = ref()
const getNFTs = async () => {
  try {
    const tokenReceiver = route.params.address
    const resp = await api({
      variables: { tokenReceiver },
      query: `
        query ($tokenReceiver: Bytes!) {
          tokens (where: {tokenReceiver: $tokenReceiver}) {
            tokenId
            tokenType { streaming }
            owner: tokenReceiver
            projectAddress: tokenRegistryAddress
            amount: amtPerSec
          }
        }
      `
    })
    nfts.value = resp.data?.tokens || []
  } catch (e) {
    console.error(e)
    nfts.value = []
  }
}

const goToMySplits = () => router.push({ name: 'user-drips-out', params: { address: store.state.address } })

const updateWithdrawable = () => {
  if (typeof getWithdrawable === 'function') {
    withdrawable.value = getWithdrawable()  
  }
}

// projects
const projects = ref()
const getProjects = async () => {
  try {
    const resp = await api({
      variables: { projectOwner: route.params.address },
      query: `
        query ($projectOwner: Bytes!) {
          fundingProjects (where: { projectOwner: $projectOwner }) {
            id
            name: projectName
            projectOwner
            daiSplit
            daiCollected
            tokenTypes {
              # tokenTypeId
              streaming
              limit
              currentTotalAmtPerSec
              currentTotalGiven
              ipfsHash
              minAmt: minAmtPerSec
            }
            tokens {
              owner: tokenReceiver
              giveAmt
              amtPerSec
            }
          }
        }
      `
    })
    projects.value = resp.data.fundingProjects
  } catch (e) {
    console.error(e)
  }
}

onMounted(() => {
  if (isMyUser.value) {
    getMyCollectable()
  }
  getSplitsIn()
  getDripsIn()
  getSplitsOut()
  getDripsOut()
  getProjects()
  getNFTs()
})

provide('isMyUser', isMyUser)
// provide('allDripsOut', allDripsOut)
provide('dripsOut', dripsOut)
provide('withdrawable', withdrawable)
</script>

<script>
const resolveRouteAddress = async (to, next, skipProjectLookup = false) => {
  try {
    const address = to.params.address.toLowerCase()
    
    // redirect to lowercase
    if (address !== to.params.address) {
      return next({name: 'user', params: { address }})
    }

    // non-address? check if ENS name, redirect to 0x...
    if (!utils.isAddress(to.params.address)) {
      const address = await store.dispatch('resolveENS', to.params.address)
      if (address) {
        // TODO: allow ENS name urls instead of redirect
        return next({ name: 'user', params: { address }})
      }
    }

    // redirect to project?
    if (!skipProjectLookup) {
      // project look up timeout... (6s?)
      const projectTimeout = setTimeout(() => {
        console.warn('project lookup timed-out. skipping...')
        // rerun but skip project lookup
        return resolveRouteAddress(to, next, true)
      }, 6000)

      // lookup...
      const projectMeta = await store.dispatch('getProjectMeta', { projectAddress: address })
      clearTimeout(projectTimeout)
      if (projectMeta?.name) {
        console.log('user is project. redirecting...')
        // redirect to project
        return next({ name: 'project', params: { address }})
      }
    }
    
    // else load this user page
    next()
  } catch (e) {
    console.error(e)
    next()
  }
}

export default {
  beforeRouteEnter: (to, from, next) => resolveRouteAddress(to, next),
  beforeRouteUpdate: (to, from, next) => resolveRouteAddress(to, next) // skip project lookup
}
</script>

<template lang="pug">
article.profile.pt-40.pb-80
  
  //- senders
  section
    .w-full.flex.justify-center
      //- (loading senders...)
      template(v-if="!allSenders")
        .h-80.px-40.rounded-full.bg-indigo-950.font-semibold.text-violet-650.flex.items-center.justify-center.text-md.animate-pulse Loading...

      //- (no senders)
      template(v-else-if="!allSenders.length")
        button.h-80.px-40.rounded-full.bg-indigo-950ff.bg-indigo-700ff.font-semibold.text-violet-650.flex.items-center.justify-center.text-md.border-dashed.border-3.text-violet-700.min-w-144.notouch_hover_text-violet-650.group(:disabled="isMyUser", :class="{'pointer-events-none': isMyUser}")
          template(v-if="!isMyUser")
            svg-plus-minus-radicle.transform.scale-105.opacity-0.group-hover_opacity-100

      //- (view senders btn)
      template(v-else)
        .relative
          //- toggle button as overlay for accessibility
          button.absolute.z-10.overlay.pointer-events-auto.rounded-full.notouch_hover_ring.notouch_hover_ring-violet-650(@click.stop="showAllSenders = !showAllSenders", aria-label="Toggle Senders List")

          //- (avatars row)
          .rounded-full.flex.justify-center.items-center.bg-indigo-700(v-show="!showAllSenders")
            //- (addresses)
            addresses-tag(:addresses="allSenders", :avatarsOnly="true")

          //- (summary text)
          .h-44.pl-20.pr-12.rounded-full.bg-indigo-950.flex.items-center.justify-center(v-show="showAllSenders")
            .font-bold.text-ms.text-violet-650 {{ allSenders.length }} address{{ allSenders.length > 1 ? 'es drip' : ' drips'}} to #[addr(:address="$route.params.address")]
            //- toggle icon
            svg-chevron-down.ml-5.text-violet-650.w-28.h-28.transform.origin-center.rotate-180
          
    
    //- (expanded list)
    template(v-if="allDripsIn && showAllSenders")
      ul.w-full.flex.flex-wrap.justify-center.mt-24
        //- .w-full.flex.my-24
          h2.mx-auto.flex.bg-indigo-950.border-violet-700.rounded-full.items-center.pl-24.pr-20.h-44.font-semiboldff.text-violet-650.text-ms
            div #[b {{ allSenders.length }} address{{ allSenders.length > 1 ? 'es' : ''}}] {{ allSenders.length > 1 ? 'drip' : 'drips'}} to #[addr.font-bold(:address="$route.params.address")]
        //- .w-full.flex.justify-center
          .h-80.w-2.rounded-full.bg-violet-700.my-6
        li(v-for="drip in allDripsIn")
          router-link.flex.items-center.bg-indigo-700.rounded-full.p-10.my-4.mx-3.notouch_hover_ring.notouch_hover_ring-violet-650.notouch_hover_text-white.transition.duration-150(:to="{name: 'user', params: { address: drip.sender }}")
            //- sender avatar / blockie
            user-avatar.w-44.h-44.flex-shrink-0.bg-indigo-800(:address="drip.sender", blockieSize="44", :key="drip.sender")
            addr.mx-16.font-semibold(:address="drip.sender", :key="drip.sender")

            .h-44.flex.items-center.px-10.bg-indigo-900.rounded-full
              //- drip icon
              div(style="font-size:1.25em") 💧

              //- amount
              div.font-semibold.text-violet-650.mx-6
                template(v-if="drip.amount") {{ drip.amount }}/mo
                template(v-else-if="drip.percent") {{ drip.percent }}%
          //- .w-full.flex.justify-center
            .h-80.w-2.rounded-full.bg-violet-700.my-6

        //- (hide senders btn)
        //- .w-full.flex.justify-center.mt-12
          button.btn.btn-darkest.w-54.h-54(@click.stop="showAllSenders = false")
            svg-chevron-down.text-violet-650.w-32.h-32.transform.rotate-180

    //- drip icon
    .w-full.flex.justify-center.my-10.opacity-90
      .relative.w-80.h-80.flex.items-center.justify-center.overflow-visible(style="font-size:2.4em")
        | 💧
        //- button.absolute.left-full.top-0.h-full.flex.items-center(v-show="showAllSenders", @click="showAllSenders = false")
          svg-chevron-down.-ml-16.text-violet-650.w-36.h-36.transform.rotate-180

  //- user tag row
  .w-full.flex.justify-center
    div
      user-tag(:address="$route.params.address")

      //- memberships/nfts count
      section.mt-6.flex.justify-center.font-semibold.text-ms.text-violet-650
        //- (memberships)
        .rounded-full.min-w-196.p-4.bg-indigo-950.flex.items-center.justify-between.px-10.mx-2
          .ml-4.mr-12.flex-1 🧧&nbsp;&nbsp;Memberships
          .rounded-full.bg-indigo-950.min-w-28.h-28.text-ms.text-white.flex.items-center.justify-center
            span(v-if="projects") {{ projects.length}}
            span.animate-pulse(v-else) ...
        
        //- (nfts)
        .rounded-full.min-w-196.p-4.bg-indigo-950.flex.items-center.justify-between.px-10.mx-2
          .ml-4.mr-12.flex-1 🧩 &nbsp;&nbsp;Member of
          .rounded-full.bg-indigo-950.min-w-28.h-28.text-ms.text-white.flex.items-center.justify-center
            span(v-if="nfts") {{ nfts.length}}
            span.animate-pulse(v-else) ...

    //- drip to button
    //- button.w-112.h-112.ml-12.flex.items-center.justify-center.bg-white.rounded-full.pr-4ff
      //- div.-ml-2.pt-2(style="font-size:2.4em") 💧
      div.-ml-3ff.font-semiboldff.text-black.pb-4(style="font-size:2.4em") +
  
  //- receivers
  .w-full.flex.justify-center.my-10.opacity-90
    .w-80.h-80.flex.items-center.justify-center.overflow-visible(style="font-size:2.4em") 💧

  .flex.justify-center
    //- (loading receivers...)
    template(v-if="!allReceivers")
      .h-80.px-40.rounded-full.bg-indigo-950.font-semibold.text-violet-650.flex.items-center.justify-center.text-md.animate-pulse Loading...

    //- (no receivers)
    template(v-else-if="!allReceivers.length")
      button.h-80.px-40.rounded-full.bg-indigo-950ff.bg-indigo-700ff.font-semibold.text-violet-650.flex.items-center.justify-center.text-md.border-dashed.border-3.text-violet-700.min-w-144.notouch_hover_text-violet-650.group(:disabled="!isMyUser", :class="{'pointer-events-none': !isMyUser}")
        template(v-if="isMyUser")
          svg-plus-minus-radicle.transform.scale-105
    
    //- (show receivers btn)
    template(v-else)  
      button.min-w-160ff.rounded-full.flex.justify-center.items-center.pointer-events-auto.notouch_hover_ring.notouch_hover_ring-violet-650(v-show="!showAllReceivers", @click.stop="showAllReceivers = !showAllReceivers", :class="{'bg-indigo-700': !showAllReceivers, 'bg-indigo-950': showAllReceivers}")
        addresses-tag(v-if="allReceivers", :addresses="allReceivers", :avatarsOnly="true")

  //- (receivers list)
  ul.flex.flex-wrap.justify-center.mt-20(v-if="allDripsOut", v-show="showAllReceivers")
    //- .w-full.flex.justify-center
      .h-80.w-2.rounded-full.bg-violet-700.my-6
    li(v-for="drip in allDripsOut")
      router-link.flex.items-center.bg-indigo-700.rounded-full.p-10.my-4.mx-3.notouch_hover_ring.notouch_hover_ring-violet-650.notouch_hover_text-white.transition.duration-150(:to="{name: 'user', params: { address: drip.receiver[0] }}")
        //- sender avatar / blockie
        user-avatar.w-44.h-44.flex-shrink-0.bg-indigo-800(:address="drip.receiver[0]", blockieSize="44", :key="drip.receiver[0]")
        addr.mx-16.font-semibold(:address="drip.receiver[0]", :key="drip.receiver[0]")

        .h-44.flex.items-center.px-10.bg-indigo-900.rounded-full
          //- drip icon
          div(style="font-size:1.25em") 💧

          //- amount
          div.font-semibold.text-violet-650.mx-6
            template(v-if="drip.amount") {{ drip.amount }}/mo
            template(v-else-if="drip.percent") {{ drip.percent }}%

    //- (hide receivers btn)
    .flex.justify-center.my-4.mx-12(:class="{'w-full mt-12': allReceivers.length > 2}")
      button.btn.btn-darkest.w-64.h-64(@click.stop="showAllReceivers = false")
        svg-chevron-down.text-violet-650.w-40.h-40.transform.rotate-180

  
  //- memberships list
  section.mt-160(v-if="projects && projects.length")
    header.flex
      h2.mx-auto.flex.bg-indigo-950.border-violet-700.rounded-full.items-center.pl-24.pr-20.h-44.font-semiboldff.text-violet-650.text-ms
        div #[addr.font-bold(:address="$route.params.address")] is raising funds with 🧧 #[b NFT Memberships] 

    .mt-144.flex.flex-wrap.justify-evenly
      //- projects...
      template(v-for="project in projects")
        //- user-project(:project="project", @collected="getProjects")
        project-detail(:project="project", @collected="getProjects")


  //- nfts list
  section.mt-144.px-20(v-if="nfts && nfts.length")
    header.flex
      h2.mx-auto.flex.bg-indigo-950.border-violet-700.rounded-full.items-center.pl-24.pr-20.h-44.font-semiboldff.text-violet-650.text-ms
        div #[addr.font-bold(:address="$route.params.address")] has #[b {{ nfts.length }} NFT Membership{{ nfts.length > 1 ? 's' : ''}}] 🧩

    ul.mt-60.grid.grid-cols-2.gap-40
      //- nfts...
      li.mb-ff.flex(v-for="nft in nfts")
        user-nft.w-full(:nft="nft")


  //- 
    header.mt-56.px-36
      .flex.items-endff.items-center.justify-between.w-full
        //- user tag
        user-tag(:address="$route.params.address")

        //- (collect btn)
        template(v-if="isMyUser")
          .flex.items-center
            //- template(v-if="totalFunds > -1")
            .h-80.flex.items-center.border.border-violet-700.rounded-full.text-xl.font-semibold.pl-32(:class="{'text-violet-650': totalFunds === -1}", :key="$route.params.address")
              template(v-if="totalFunds !== -1")
                | {{ totalFunds }}
                svg-dai.ml-6(size="lg")
              template(v-else)
                .animate-pulse ...
              
              button.ml-24.btn.btn-lg.btn-white.text-xl.font-semibold.pl-36.pr-32(@click="collectModalOpen = true") Collect 💧

            //- (edit drips btn)
            button.ml-6.btn.btn-lg.btn-violet.text-xl.font-semibold.pl-36.pr-32(@click="editDripsSelect = true") Edit Drips 💧
        
        //- (drip to btn)
        template(v-else)
          button.btn.btn-lg.btn-white.font-semibold.text-md.pl-36.pr-32.text-xl(@click="dripModalOpen = true")
            | Drip to {{ ensName ? ensName.slice(0, 7) : '0x' }}... 💧
            //- | Send Drips 💧

      nav.mt-56.mb-20
        .flex.items-start.justify-between.text-violet-650.text-lg
          .flex.tracking-wide
            router-link.h-80.btn.btn-indigo.btn-active-violet.font-semibold.pl-28.pr-36.mr-2(:to="{ name: 'user-drips', params: $route.params }", :class="{'btn-violet': $route.name.includes('user-drips') }")
              span.mr-14.-ml-5(style="font-size:1.18em") 💧
              | Drips
            router-link.h-80.btn.btn-indigo.btn-active-violet.font-semibold.pl-28.pr-36.mr-2(:to="{ name: 'user-communities', params: $route.params }", :class="{'btn-violet': $route.name.includes('user-communities') }")
              span.mr-14.-ml-4(style="font-size:1.23em") 🙂
              | Communities

          //- (communities submenu)
          template(v-if="$route.name.includes('user-communities')")
            .h-80.rounded-full.flex.items-center.px-16.bg-indigo-700
              router-link.btn.btn-active-violet.btn-md.font-semibold.text-lg.px-24.mr-4(:to="{ name: 'user-communities', params: $route.params }") Created
              router-link.btn.btn-active-violet.btn-md.font-semibold.text-lg.px-24(:to="{ name: 'user-communities-joined', params: $route.params }") Joined

          //- (drips submenu)
          template(v-if="$route.name.includes('user-drips')")
            //- horizontal stem
            //- .w-40.h-40.border-b-2.border-indigo-700
            //- submenu body
            .h-80.rounded-full.flex.items-center.px-16.bg-indigo-700
              router-link.btn.btn-active-violet.btn-md.font-semibold.text-lg.px-32.mr-4(:to="{ name: 'user-drips-in', params: $route.params }", ) In
              router-link.btn.btn-active-violet.btn-md.font-semibold.text-lg.px-32(:to="{ name: 'user-drips-out', params: $route.params }", ) Out

    main#main.px-36.min-h-screen

      router-view(:key="$route.path", @editDripsSelect="editDripsSelect = true", @editDrips="edit = 'drips'")

  //- (MY USER)
  template(v-if="isMyUser")
    //- COLLECT
    modal-collect-drips(v-if="collectModalOpen", :open="collectModalOpen", @close="collectModalOpen = false; getMyCollectable()", :amts="collectableAmts", @collected="getMyCollectable")
      template(v-slot:header) Collect your Drips

    //- EDIT
    //- select drip type to edit...
    modal-edit-drips-select(:open="editDripsSelect", @close="editDripsSelect = false", @select="e => { edit = e; editDripsSelect = false }", :edit="allDripsOut && allDripsOut.length")

    //- edit drips...
    template(v-if="edit === 'drips'")
      modal-drips-edit(:open="edit === 'drips'", @close="edit = null; getDrips()", @updated="getDrips", :addFundsOnly="edit === 'funds'")
        template(v-slot:header)
          h6 Drip to Others
        template(v-slot:description)
          p {{ allDripsOut && allDripsOut.length ? 'Edit the' : 'Add' }} addresses to drip funds to #[b.text-violet-650 every month.]

    //- edit splits...
    template(v-if="edit==='splits'")
      modal-splits-edit(:open="edit === 'splits'", @close="edit = null; getSplits()", @updated="getSplits", @viewSplits="goToMySplits")
        template(v-slot:header)
          h6 Split your Drips
        template(v-slot:description)
          p.mx-auto(style="max-width:22em")
            | Anytime you receive drips, they will be #[b split] with the addresses below:
          //- 
            template(v-if="splitsOut && splitsOut.length")
              | Edit the addresses you #[b.text-violet-650 share]<br>your incoming funds with.
            template(v-else)
              | Add addresses that you will #[b.text-violet-650 share]<br>your incoming funds with.

  //- (OTHER USER)
  template(v-else)
    template(v-if="dripModalOpen")
      //- drip to this user
      modal-drip-to(:address="$route.params.address", :open="dripModalOpen", @close="dripModalOpen = false")
        template(v-slot:header)
         h6 Drip to<br>#[addr.text-violet-650(:address="props.address")]

</template>
